// Generated by CoffeeScript 1.3.3
(function() {
  var async, clear, construct_class, construct_class_field, construct_class_file, construct_classes_from_dir, construct_classes_from_file, construct_db_field, construct_db_field_query, constructed_artifacts, cradle, db, ejs, fs, init, path,
    _this = this;

  fs = require('fs');

  path = require('path');

  cradle = require('cradle');

  async = require('async');

  ejs = require('ejs');

  constructed_artifacts = [];

  clear = function() {
    var cls, _i, _len;
    for (_i = 0, _len = constructed_artifacts.length; _i < _len; _i++) {
      cls = constructed_artifacts[_i];
      delete module.exports[cls];
    }
    return constructed_artifacts = [];
  };

  construct_class_field = function(cls, key, field) {
    var _ref;
    if (field.type === 'text') {
      cls[key] = (_ref = field.default_value) != null ? _ref : '';
    }
    if (field.type === 'ref') {
      return cls[key] = new module.exports[field.item_template_name];
    }
  };

  construct_db_field = function(dest, key, field, source) {
    if (field.type === 'text') {
      return dest[key] = source[key];
    }
  };

  construct_db_field_query = function(dest, key, field, source) {
    if (field.type === 'text') {
      return dest[key] = function(doc) {
        if (doc.resource === field.name && doc[key] === source[key]) {
          return emit(doc.id, doc);
        }
      };
    }
  };

  construct_class_file = function(template_file_name, default_name, template) {
    var params, t, _ref, _ref1;
    t = "require '<%= template_file_name %>'\n# hallo\nclass <%= name %>\n  constructor: ->  \n";
    params = {};
    params.template_file_name = template_file_name;
    params.template_instance = new template;
    params.name = (_ref = params.template_instance.__name) != null ? _ref : default_name;
    params.plural = (_ref1 = params.template_instance.__plural) != null ? _ref1 : params.name + 's';
    return console.log(ejs.render(t, params));
  };

  construct_class = function(default_name, template) {
    var db_view, key, name, plural, template_instance, _i, _len, _ref, _ref1, _ref2;
    template_instance = new template;
    name = (_ref = template_instance.__name) != null ? _ref : default_name;
    plural = (_ref1 = template_instance.__plural) != null ? _ref1 : name + 's';
    db_view = {};
    _ref2 = Object.keys(template_instance);
    for (_i = 0, _len = _ref2.length; _i < _len; _i++) {
      key = _ref2[_i];
      construct_db_field(db_view, key, template_instance[key], _this);
    }
    constructed_artifacts.push(name);
    module.exports[name] = function() {
      var _j, _len1, _ref3,
        _this = this;
      this.__name = name;
      this.template_instance = template_instance;
      _ref3 = Object.keys(template_instance);
      for (_j = 0, _len1 = _ref3.length; _j < _len1; _j++) {
        key = _ref3[_j];
        construct_class_field(this, key, template_instance[key]);
      }
      this.save = function(callback) {
        var db_val, _k, _len2, _ref4;
        db_val = {};
        db_val.resource = _this.__name;
        _ref4 = Object.keys(template_instance);
        for (_k = 0, _len2 = _ref4.length; _k < _len2; _k++) {
          key = _ref4[_k];
          construct_db_field(db_val, key, template_instance[key], _this);
        }
        if (_this.__id) {
          db.merge(_this.__id, db_val, function(err, res) {
            if (err) {
              console.log('---', err, res);
            } else {
              _this.__id = res.id;
            }
            return callback();
          });
        } else {
          db.save(db_val, function(err, res) {
            if (err) {
              console.log('---', err, res);
            } else {
              _this.__id = res.id;
            }
            return callback();
          });
        }
        return void 0;
      };
      return void 0;
    };
    module.exports[name].load = function(id) {};
    constructed_artifacts.push(plural);
    return module.exports[plural] = {
      load: function() {}
    };
  };

  construct_classes_from_file = function(file) {
    var key, tmp, _i, _j, _len, _len1, _ref, _ref1, _results;
    tmp = require(file);
    _ref = Object.keys(tmp);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      key = _ref[_i];
      construct_class(key, tmp[key]);
    }
    _ref1 = Object.keys(tmp);
    _results = [];
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      key = _ref1[_j];
      _results.push(construct_class_file(file, key, tmp[key]));
    }
    return _results;
  };

  construct_classes_from_dir = function(dir) {
    var file, _i, _len, _ref, _results;
    _ref = fs.readdirSync(dir);
    _results = [];
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      file = _ref[_i];
      _results.push(construct_classes_from_file(path.join(dir, file)));
    }
    return _results;
  };

  db = void 0;

  init = function(settings, callback) {
    var c;
    c = new cradle.Connection();
    db = c.database('test');
    return async.series([
      function(acallback) {
        return db.create(function() {
          return acallback(null, null);
        });
      }, function(acallback) {
        var dir, _i, _len, _ref;
        _ref = settings.template_dirs;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          dir = _ref[_i];
          construct_classes_from_dir(path.join(settings.root_dir, dir));
        }
        return acallback(null, null);
      }
    ], function() {
      return callback();
    });
  };

  module.exports.clear = clear;

  module.exports.construct_class = construct_class;

  module.exports.init = init;

}).call(this);
